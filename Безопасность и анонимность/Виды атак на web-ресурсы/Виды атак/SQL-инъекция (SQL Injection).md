### Что такое SQL-инъекция?

**SQL-инъекция (SQL Injection)** — это тип атаки на веб-приложение, при котором злоумышленник внедряет вредоносные SQL-запросы в места, где программа взаимодействует с базой данных. Если приложение небезопасно обрабатывает вводимые данные, атакующий может выполнить произвольные SQL-запросы, что может привести к утечке данных, изменению или удалению информации, а иногда даже к получению полного контроля над базой данных.

### Как работает SQL-инъекция?

Атака происходит, когда пользовательские данные передаются в SQL-запрос без должной проверки или фильтрации. Например, если приложение строит SQL-запрос с использованием строковых вставок на основе пользовательского ввода, злоумышленник может изменить структуру запроса, добавив свой код.

#### Пример уязвимого кода:
```php
<?php
$username = $_GET['username']; // Получаем имя пользователя из запроса
$password = $_GET['password']; // Получаем пароль из запроса

// Уязвимый SQL-запрос
$query = "SELECT * FROM users WHERE username = '$username' AND password = '$password'";
$result = mysqli_query($conn, $query);
?>
```

Если злоумышленник введет в поле `username` что-то вроде:

```
' OR '1'='1
```

то итоговый SQL-запрос будет выглядеть так:

```sql
SELECT * FROM users WHERE username = '' OR '1'='1' AND password = ''
```

Этот запрос всегда будет истинным из-за выражения `OR '1'='1'`, что позволяет злоумышленнику войти в систему без правильных учетных данных.

### Типы SQL-инъекций

#### 1. **Классическая SQL-инъекция**
Наиболее распространенный тип, когда вводимые данные прямо включаются в SQL-запрос. Пример уже был показан выше.

#### 2. **Слепая SQL-инъекция (Blind SQL Injection)**
Если приложение не отображает результаты SQL-запроса напрямую, но поведение страницы изменяется в зависимости от результата, можно использовать слепую SQL-инъекцию для извлечения информации через серию проб и ошибок. Например, злоумышленник может отправить запрос, который будет проверять наличие данных по результату времени отклика или перенаправления страницы.

#### 3. **Инъекция на основе ошибок (Error-based SQL Injection)**
Этот тип атаки используется для получения информации из сообщений об ошибках базы данных. Например, атакующий может попробовать ввести данные, которые приведут к ошибке в базе данных, чтобы получить полезную информацию об её структуре.

#### 4. **Union-инъекция (Union-based SQL Injection)**
Атакующий использует оператор `UNION` для объединения результатов двух запросов. Это позволяет ему получать информацию из других таблиц базы данных, которые иначе были бы недоступны.

Пример:
```sql
SELECT username, password FROM users WHERE id = 1 UNION SELECT version(), database();
```
Этот запрос вернет текущую версию SQL-сервера и имя базы данных, добавленное к результатам запроса о пользователях.

#### 5. **Внедрение через подзапросы**
Внедрение может происходить через вложенные запросы, изменяя поведение базы данных с помощью дополнительных подзапросов.

### Последствия SQL-инъекции

- **Кража данных**: Злоумышленник может получить доступ к конфиденциальной информации, такой как имена пользователей, пароли, номера кредитных карт и другие данные.
- **Модификация данных**: SQL-инъекция позволяет злоумышленнику изменять, удалять или вставлять новые данные в базу.
- **Удаление данных**: Возможность выполнения запросов на удаление таблиц или записей.
- **Получение полного контроля над сервером**: В некоторых случаях SQL-инъекция может привести к выполнению системных команд на сервере базы данных, что позволит злоумышленнику получить контроль над сервером.

### Как защититься от SQL-инъекций

#### 1. **Использование подготовленных выражений (Prepared Statements)**
Это самый эффективный метод предотвращения SQL-инъекций. Подготовленные выражения (также известные как параметризованные запросы) автоматически экранируют пользовательский ввод, что предотвращает внедрение вредоносного кода.

Пример на PHP с использованием PDO:
```php
$stmt = $pdo->prepare('SELECT * FROM users WHERE username = :username AND password = :password');
$stmt->execute(['username' => $username, 'password' => $password]);
```

Здесь SQL-запрос и параметры передаются отдельно, что делает SQL-инъекции невозможными.

#### 2. **Экранирование данных**
Если вы используете старый подход с динамическим построением SQL-запросов, необходимо экранировать пользовательские данные перед вставкой в запрос. Например, в PHP можно использовать функцию `mysqli_real_escape_string()`.

#### 3. **Валидация и фильтрация пользовательского ввода**
Всегда проверяйте и фильтруйте данные, которые получаете от пользователя. Например, для полей с числами убедитесь, что они действительно содержат только цифры.

#### 4. **Минимизация привилегий базы данных**
Аккаунт базы данных, который использует ваше приложение, должен иметь минимальные привилегии. Например, если приложение только читает данные, используйте учетную запись с правами только на чтение.

#### 5. **Использование ORM (Object-Relational Mapping)**
Многие современные фреймворки предлагают ORM-инструменты, которые абстрагируют работу с базой данных и помогают избежать ошибок, связанных с SQL-инъекциями. Примеры: Doctrine для PHP, Hibernate для Java.

#### 6. **Ограничение выводимых ошибок**
Не показывайте пользователям ошибки базы данных, так как они могут содержать полезную информацию для атаки.

#### 7. **Использование веб-фаерволов (WAF)**
Веб-фаерволы могут блокировать подозрительные SQL-запросы еще до того, как они достигнут базы данных.

### Заключение

SQL-инъекции остаются одной из самых опасных и распространенных угроз для веб-приложений, особенно при неправильной обработке данных пользователя. Следование лучшим практикам по безопасности и использованию современных инструментов помогает избежать этой уязвимости.