### Что такое CSRF (Cross-Site Request Forgery)?

**CSRF (Cross-Site Request Forgery)** — это тип атаки на веб-приложение, при котором злоумышленник обманывает пользователя, заставляя его выполнять нежелательные действия на сайте, на котором он уже авторизован. В этом случае атакующий использует доверие веб-сайта к пользователю, чтобы заставить его браузер выполнить запрос от имени жертвы без её ведома.

CSRF-атаки обычно направлены на действия, изменяющие состояние на сервере (например, изменение пароля, перевод денег, отправка формы), но не могут украсть данные напрямую, поскольку злоумышленник не имеет доступа к ответам сервера.

### Как работает CSRF-атака?

Сценарий работы CSRF-атаки может быть следующим:

1. **Авторизация пользователя**: Пользователь входит в доверенный сайт (например, интернет-банк) и его сессия сохраняется через cookie-файлы.
   
2. **Атака**: Пользователь, не выходя из доверенного сайта, посещает другой вредоносный сайт или кликает на ссылку, контролируемую злоумышленником.

3. **Отправка запроса**: Вредоносный сайт или ссылка заставляет браузер пользователя выполнить запрос на доверенный сайт (например, перевод денег, изменение настроек), используя сохранённые cookie сессии.

4. **Выполнение запроса**: Доверенный сайт не видит разницы между намеренным запросом пользователя и подделанным запросом злоумышленника, потому что запрос исходит от браузера пользователя с действительными cookie.

#### Пример атаки CSRF:

Допустим, пользователь вошёл в свой банковский аккаунт, и злоумышленник знает, что запрос на перевод денег выглядит следующим образом:

```
POST https://bank.com/transfer
Body:
amount=1000&recipient=attacker_account
```

Злоумышленник может разместить на своём сайте код, который автоматически отправляет такой запрос:

```html
<img src="https://bank.com/transfer?amount=1000&recipient=attacker_account" style="display:none;">
```

Если пользователь, авторизованный в интернет-банке, зайдёт на сайт злоумышленника, его браузер выполнит запрос к банковскому серверу с сохранёнными cookie, что приведёт к переводу денег.

### Условия успешной CSRF-атаки

Для успешной атаки должны соблюдаться следующие условия:

1. **Пользователь авторизован в целевом приложении**: В браузере пользователя должны быть действительные сессионные cookie.
   
2. **Нет дополнительной проверки данных**: Целевой сайт не выполняет дополнительных проверок, кроме проверки cookie (например, не требует повторной аутентификации или подтверждения действий).

3. **Злоумышленник может заставить браузер пользователя отправить запрос**: Это может быть сделано через ссылки, формы, изображения или даже JavaScript.

### Последствия CSRF-атак

CSRF-атаки могут привести к следующим последствиям:

- **Неавторизованные транзакции**: Например, перевод денег или оплата услуг от имени пользователя.
  
- **Изменение настроек аккаунта**: Например, изменение адреса электронной почты, пароля или других данных.
  
- **Подписка на платные услуги**: Пользователь может быть автоматически подписан на платные услуги без своего ведома.

- **Удаление данных**: Злоумышленник может инициировать удаление важных данных или учётной записи.

### Защита от CSRF-атак

Существует несколько способов защиты от CSRF-атак:

#### 1. **CSRF-токены (anti-CSRF токены)**

Один из самых надёжных методов защиты — это использование **CSRF-токенов**. Эти токены представляют собой случайные значения, которые генерируются сервером и отправляются вместе с каждой формой или запросом, изменяющим данные. Сервер проверяет наличие и правильность токена при каждом запросе, и если токен отсутствует или неверен, запрос отклоняется.

Пример использования CSRF-токенов:

- Сервер генерирует уникальный CSRF-токен и вставляет его в форму как скрытое поле.
  
- Когда пользователь отправляет форму, CSRF-токен передаётся вместе с данными.
  
- Сервер проверяет токен и, если он валиден, разрешает выполнение действия.

Пример HTML-кода с CSRF-токеном:
```html
<form action="/change-password" method="POST">
  <input type="hidden" name="csrf_token" value="RANDOM_TOKEN">
  <input type="password" name="new_password">
  <button type="submit">Change Password</button>
</form>
```

На серверной стороне токен проверяется и только в случае его правильности запрос обрабатывается.

#### 2. **Проверка реферера и заголовка Origin**

Веб-приложения могут проверять заголовки `Referer` и `Origin`, которые браузеры отправляют с запросами. Эти заголовки показывают, с какого сайта был отправлен запрос. Если запрос приходит с другого сайта, сервер может отклонить его.

Пример проверки заголовка Origin:
```php
if ($_SERVER['HTTP_ORIGIN'] !== 'https://trusted-site.com') {
  die('CSRF protection: invalid origin');
}
```

Недостатки: некоторые браузеры могут не всегда отправлять эти заголовки, а злоумышленник может изменить их в некоторых сценариях.

#### 3. **Требование повторной аутентификации**

Для особо чувствительных операций (например, изменения пароля или перевода денег) рекомендуется запрашивать повторное подтверждение личности пользователя через ввод пароля или использование двухфакторной аутентификации (2FA).

#### 4. **Использование методов POST для изменения данных**

Хотя использование метода `POST` не защищает от CSRF напрямую, оно может усложнить выполнение атак, так как злоумышленник не сможет так просто подделать запросы через URL (которые используют метод `GET`).

#### 5. **Cookie с флагом SameSite**

Современные браузеры поддерживают флаг `SameSite` для cookie. Если установить этот флаг, браузер не будет отправлять cookie в кросс-доменных запросах, что предотвращает CSRF-атаки.

Пример настройки cookie с флагом SameSite:
```http
Set-Cookie: sessionId=abc123; SameSite=Strict;
```

Флаг `SameSite` может быть установлен в режимы:

- **Strict**: Cookie отправляются только при навигации на тот же домен.
  
- **Lax**: Cookie отправляются с обычными навигационными запросами, но не отправляются при загрузке сторонних ресурсов (например, картинок или ссылок).
  
- **None**: Cookie отправляются всегда (используйте с осторожностью, так как это менее безопасно).

#### 6. **Ограничение времени жизни сессий и токенов**

Сокращение времени жизни сессионных данных и CSRF-токенов может уменьшить вероятность успешной CSRF-атаки, так как злоумышленнику будет сложнее воспользоваться устаревшей сессией или токеном.

### Заключение

CSRF-атаки могут быть очень опасными, так как они используют доверие веб-сайта к пользователю, чтобы выполнять действия от его имени. Однако с правильными механизмами защиты, такими как CSRF-токены, проверка реферера и использование флага SameSite для cookie, можно значительно уменьшить риск таких атак. Разработчики должны быть особенно внимательны к безопасности веб-приложений, которые работают с важными данными или транзакциями.