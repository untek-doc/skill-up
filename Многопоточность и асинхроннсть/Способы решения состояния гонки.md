#### **1. Мьютексы (Mutexes)**
Мьютексы позволяют ограничить доступ к общему ресурсу, обеспечивая, что только один поток/процесс может работать с ним в конкретный момент времени.

**Пример с файловой блокировкой в PHP:**
```php
<?php
$file = fopen("lockfile.txt", "c+");

if (flock($file, LOCK_EX)) { // Эксклюзивная блокировка
    // Критическая секция
    $counter = (int)fread($file, filesize("lockfile.txt"));
    $counter++;
    ftruncate($file, 0);
    rewind($file);
    fwrite($file, $counter);
    fflush($file);
    flock($file, LOCK_UN); // Снимаем блокировку
}

fclose($file);
?>
```

---

#### **2. Redis или Memcached для атомарных операций**
Эти системы поддерживают атомарные операции, такие как `INCR` или `SETNX`, которые гарантируют корректное обновление данных.

**Пример с Redis:**
```php
<?php
$redis = new Redis();
$redis->connect('127.0.0.1', 6379);

// Атомарное увеличение значения
$counter = $redis->incr("counter");
echo "Counter value: $counter";
?>
```

---

#### **3. Транзакции в базе данных**
Транзакции позволяют объединить несколько операций в одну неделимую последовательность, что предотвращает конкуренцию за ресурс.

**Пример на MySQL с использованием транзакций:**
```php
<?php
$pdo = new PDO("mysql:host=localhost;dbname=test", "root", "");
$pdo->beginTransaction();

try {
    $stmt = $pdo->query("SELECT counter FROM counters WHERE id = 1 FOR UPDATE");
    $row = $stmt->fetch(PDO::FETCH_ASSOC);
    $counter = $row['counter'] + 1;

    $stmt = $pdo->prepare("UPDATE counters SET counter = ? WHERE id = 1");
    $stmt->execute([$counter]);

    $pdo->commit();
    echo "Counter updated: $counter";
} catch (Exception $e) {
    $pdo->rollBack();
    echo "Failed: " . $e->getMessage();
}
?>
```

---

#### **4. Очереди сообщений**
Использование очередей сообщений, таких как RabbitMQ или Beanstalkd, позволяет избежать одновременного доступа к ресурсу, так как каждая задача обрабатывается по очереди.

**Пример с Beanstalkd:**
```php
<?php
require 'vendor/autoload.php';

$pheanstalk = new Pheanstalk\Pheanstalk('127.0.0.1');

// Добавление задачи в очередь
$pheanstalk->useTube('tasks')->put(json_encode(['task' => 'increment']));

// Обработка задачи
$job = $pheanstalk->watch('tasks')->reserve();
$data = json_decode($job->getData(), true);
echo "Processing task: " . $data['task'];
$pheanstalk->delete($job);
?>
```

---

#### **5. Иммутабельность данных**
Вместо изменения общего состояния создаются новые неизменяемые объекты, что исключает возможность гонки.

**Пример:**
```php
<?php
function incrementCounter(array $data): array {
    $newData = $data;
    $newData['counter']++;
    return $newData;
}

$data = ['counter' => 0];
$data = incrementCounter($data);

print_r($data); // ['counter' => 1]
?>
```

---

#### **6. Optimistic Locking (оптимистичная блокировка)**
Использует версии данных для проверки их актуальности перед обновлением.

**Пример с MySQL:**
```php
<?php
$pdo = new PDO("mysql:host=localhost;dbname=test", "root", "");

$id = 1;
$version = 1;

$stmt = $pdo->prepare("UPDATE counters SET counter = counter + 1, version = version + 1 WHERE id = ? AND version = ?");
$result = $stmt->execute([$id, $version]);

if ($result && $stmt->rowCount() > 0) {
    echo "Counter updated successfully.";
} else {
    echo "Update failed due to race condition.";
}
?>
```

---

#### **7. Локальные атомарные операции**
PHP расширение APCu предоставляет механизм атомарных операций, подходящих для локальных серверов.

**Пример с APCu:**
```php
<?php
apcu_add('counter', 0);

$counter = apcu_inc('counter');
echo "Counter: $counter";
?>
```

---

#### **8. Семафоры (Semaphores)**
Семафоры позволяют ограничить доступ к ресурсу определённым количеством потоков одновременно.

**Пример:**
```php
<?php
$key = ftok(__FILE__, 'a');
$semaphore = sem_get($key);

if (sem_acquire($semaphore)) {
    // Критическая секция
    echo "Accessing shared resource\n";
    sleep(2);
    sem_release($semaphore);
}
?>
```

---

#### **9. Версионирование данных**
Использование версий данных для отслеживания изменений позволяет минимизировать состояние гонки.

**Пример:**
```php
<?php
// Перед изменением данных проверяем, совпадает ли версия с ожидаемой
$stmt = $pdo->prepare("UPDATE counters SET value = ?, version = ? WHERE id = ? AND version = ?");
$stmt->execute([$newValue, $newVersion, $id, $currentVersion]);
```

---

#### **10. Использование функционального программирования**
Функциональное программирование основывается на неизменяемых данных и чистых функциях, что предотвращает побочные эффекты.

**Пример на PHP:**
```php
<?php
function add($a, $b) {
    return $a + $b; // Чистая функция
}

$result = add(3, 5);
echo $result; // 8
?>
```

---

### Итог
Выбор подхода зависит от конкретной задачи:
- **Мьютексы и семафоры**: для локальных операций.
- **Redis/Memcached**: для высокопроизводительных систем.
- **Транзакции/Optimistic Locking**: при использовании баз данных.
- **Очереди сообщений**: для асинхронных систем.
- **Иммутабельность/функциональное программирование**: для проектирования безопасной архитектуры.

Комбинирование нескольких подходов часто является лучшим решением.