Автоматизация проверки протечки слоев в PHP — важный процесс для соблюдения принципов слоистой архитектуры (например, в рамках **DDD**, **чистой архитектуры** или **Hexagonal Architecture**). Для этого можно использовать специализированные инструменты статического анализа и дополнительные проверки кода.

---

### **Основные шаги автоматизации проверки**

#### 1. **Определите границы слоев**

Перед началом автоматизации нужно четко обозначить границы слоев в проекте. Например:

- **Доменный слой (Domain)** — бизнес-логика, независимая от внешних систем.
- **Приложение (Application)** — слой, где координируются действия домена.
- **Инфраструктура (Infrastructure)** — реализация взаимодействия с внешними системами (БД, API и т.д.).
- **Презентация (Presentation)** — обработка запросов и генерация ответов (HTTP-контроллеры, консольные команды).

#### 2. **Используйте пространства имен**

Для каждого слоя задайте свои пространства имен, чтобы было легче идентифицировать, к какому слою относится тот или иной класс.

Пример:

```php
src/
├── Domain/
├── Application/
├── Infrastructure/
├── Presentation/
```

---

#### 3. **Инструменты для проверки**

##### **PHPStan**

[PHPStan](https://phpstan.org/) — это статический анализатор для PHP, который позволяет написать правила проверки, чтобы убедиться, что зависимости между слоями не нарушены.

- Установите PHPStan:
    
    ```bash
    composer require --dev phpstan/phpstan
    ```
    
- Создайте конфигурацию, которая запрещает доступ из одного слоя к другому:
    
    ```neon
    parameters:
        layers:
            - name: Domain
              paths:
                  - src/Domain
            - name: Application
              paths:
                  - src/Application
            - name: Infrastructure
              paths:
                  - src/Infrastructure
            - name: Presentation
              paths:
                  - src/Presentation
        rules:
            - Domain should not depend on Application
            - Domain should not depend on Infrastructure
            - Domain should not depend on Presentation
            - Application should not depend on Infrastructure
            - Application should not depend on Presentation
    ```
    
- Включите [PHPStan Extensions](https://phpstan.org/developing-extensions) для более гибких проверок.
    

##### **Deptrac**

[Deptrac](https://qossmic.github.io/deptrac/) — инструмент, специально предназначенный для проверки зависимостей между слоями. Он отлично подходит для соблюдения правил слоистой архитектуры.

- Установите Deptrac:
    
    ```bash
    composer require --dev qossmic/deptrac
    ```
    
- Создайте конфигурационный файл `depfile.yaml`:
    
    ```yaml
    layers:
      - name: Domain
        collectors:
          - type: directory
            regex: src/Domain/
      - name: Application
        collectors:
          - type: directory
            regex: src/Application/
      - name: Infrastructure
        collectors:
          - type: directory
            regex: src/Infrastructure/
      - name: Presentation
        collectors:
          - type: directory
            regex: src/Presentation/
    
    ruleset:
      Domain:
        - Application
      Application:
        - Infrastructure
        - Presentation
    ```
    
- Запустите проверку:
    
    ```bash
    ./vendor/bin/deptrac analyze
    ```
    

##### **Custom CI-проверки**

Если стандартные инструменты не подходят, можно написать собственные скрипты на PHP, которые анализируют структуру проекта. Для этого можно использовать рефлексию или библиотеку **nikic/php-parser**.

---

#### 4. **Настройка в CI/CD**

Интегрируйте проверки в вашу CI/CD-пайплайн, чтобы автоматизировать процесс:

- Включите команды проверки (например, `phpstan` или `deptrac`) в конфигурацию вашего CI, например, в GitHub Actions:
    
    ```yaml
    name: Analyze Codebase
    
    on: [push, pull_request]
    
    jobs:
      analyze:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v3
          - name: Install PHP
            uses: shivammathur/setup-php@v3
            with:
              php-version: '8.1'
              tools: composer
          - name: Install Dependencies
            run: composer install --no-progress --no-suggest
          - name: Run PHPStan
            run: vendor/bin/phpstan analyse
          - name: Run Deptrac
            run: vendor/bin/deptrac analyze
    ```
    

---

### **Примеры нарушений и их предотвращение**

#### Пример 1: Нарушение зависимости

Если контроллер из слоя Presentation пытается использовать класс из Infrastructure напрямую, это считается нарушением.

- **Неправильно**:
    
    ```php
    namespace Presentation\Controller;
    
    use Infrastructure\Repository\UserRepository;
    
    class UserController {
        public function __construct(private UserRepository $repository) {}
    }
    ```
    
- **Правильно**: Используйте интерфейс из слоя Application:
    
    ```php
    namespace Application\UseCase;
    
    interface UserService {
        public function findUser(int $id): User;
    }
    ```
    
    А реализация должна быть в Infrastructure:
    
    ```php
    namespace Infrastructure\Service;
    
    use Application\UseCase\UserService;
    
    class UserServiceImpl implements UserService {
        public function findUser(int $id): User {
            // Логика доступа к данным
        }
    }
    ```
    

---

### **Заключение**

Автоматизация проверки протечек между слоями позволяет соблюдать архитектурные принципы и предотвращать рост технического долга. Инструменты, такие как PHPStan и Deptrac, значительно упрощают процесс анализа и интеграции таких проверок в CI/CD. Такой подход особенно важен в сложных и долгоживущих проектах.