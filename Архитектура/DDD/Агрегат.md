В **Domain-Driven Design (DDD)** концепции **агрегатов** и **корневых агрегатов** играют ключевую роль в структурировании моделей домена. Они помогают организовать данные и бизнес-логику, обеспечивая целостность и согласованность состояния объектов.

### Агрегат

**Агрегат** — это группа связанных объектов (сущностей и значимых объектов), которые рассматриваются как единое целое для целей изменения данных. Агрегаты помогают управлять сложностью системы, ограничивая область действия изменений и обеспечивая целостность данных.

#### Характеристики агрегата:
1. **Согласованность**:
   - Все изменения состояния агрегата должны быть согласованными. Это означает, что изменения внутри агрегата должны быть атомарными и, как правило, должны быть выполнены в одной транзакции.

2. **Границы агрегата**:
   - Агрегаты имеют четко определенные границы. Объекты за пределами агрегата не могут напрямую ссылаться на внутренние объекты, чтобы предотвратить несогласованность.

3. **Управление жизненным циклом**:
   - Агрегаты могут включать логику, которая управляет состоянием своих сущностей и значимых объектов, обеспечивая целостность и согласованность.

### Корневой агрегат

**Корневой агрегат** — это основная сущность в агрегате, которая управляет его состоянием и обеспечивает доступ к другим объектам внутри агрегата. Каждый агрегат имеет один корневой агрегат, который отвечает за инкапсуляцию логики и ограничивает доступ к внутренним объектам.

#### Характеристики корневого агрегата:
1. **Уникальный идентификатор**:
   - Корневой агрегат имеет уникальный идентификатор, который используется для его идентификации в системе.

2. **Контроль доступа**:
   - Все операции, которые затрагивают внутренние объекты агрегата, должны выполняться через корневой агрегат. Это обеспечивает контроль над изменениями и целостностью агрегата.

3. **Инкапсуляция логики**:
   - Корневой агрегат содержит бизнес-логику, связанную с управлением состоянием и поведением объектов внутри агрегата.

### Пример агрегата и корневого агрегата

Рассмотрим пример агрегата, представляющего заказ (Order), который содержит корневой агрегат `Order` и связанные с ним элементы заказа (OrderItem):

#### Класс Order (Корневой агрегат)

```php
class Order {
    private string $id; // Уникальный идентификатор корневого агрегата
    private array $items = []; // Элементы заказа
    private string $customerId;

    public function __construct(string $id, string $customerId) {
        $this->id = $id;
        $this->customerId = $customerId;
    }

    public function addItem(Product $product, int $quantity): void {
        // Логика добавления элемента заказа
        $item = new OrderItem($product, $quantity);
        $this->items[] = $item;
    }

    public function getItems(): array {
        return $this->items;
    }

    public function getId(): string {
        return $this->id;
    }

    public function getCustomerId(): string {
        return $this->customerId;
    }

    // Другие методы, управляющие состоянием заказа
}
```

#### Класс OrderItem (Элемент заказа)

```php
class OrderItem {
    private Product $product; // Продукт
    private int $quantity; // Количество

    public function __construct(Product $product, int $quantity) {
        $this->product = $product;
        $this->quantity = $quantity;
    }

    public function getProduct(): Product {
        return $this->product;
    }

    public function getQuantity(): int {
        return $this->quantity;
    }
}
```

#### Класс Product (Продукт)

```php
class Product {
    private string $id;
    private string $name;
    private float $price;

    public function __construct(string $id, string $name, float $price) {
        $this->id = $id;
        $this->name = $name;
        $this->price = $price;
    }

    public function getId(): string {
        return $this->id;
    }

    public function getName(): string {
        return $this->name;
    }

    public function getPrice(): float {
        return $this->price;
    }
}
```

### Пример использования

Теперь мы можем создать заказ и добавить к нему элементы:

```php
// Создание продукта
$product1 = new Product("1", "Laptop", 1200.00);
$product2 = new Product("2", "Smartphone", 800.00);

// Создание заказа
$order = new Order("1001", "customer123");

// Добавление элементов заказа
$order->addItem($product1, 1);
$order->addItem($product2, 2);

// Получение информации о заказе
echo "Order ID: " . $order->getId() . "\n";
echo "Customer ID: " . $order->getCustomerId() . "\n";
echo "Items in Order:\n";

foreach ($order->getItems() as $item) {
    echo "- Product: " . $item->getProduct()->getName() . ", Quantity: " . $item->getQuantity() . "\n";
}
```

### Когда использовать агрегаты и корневые агрегаты

- **Сложные модели**: Когда бизнес-логика требует взаимодействия нескольких сущностей и значимых объектов, агрегаты помогают организовать их в единые логические группы.
- **Поддержание целостности**: Агрегаты помогают поддерживать целостность данных и обеспечивают согласованность при изменении состояния.
- **Упрощение взаимодействия**: Корневые агрегаты предоставляют простой интерфейс для взаимодействия с агрегатом, позволяя избежать сложных зависимостей.

### Заключение

Агрегаты и корневые агрегаты являются важными концепциями в DDD, позволяющими организовать бизнес-логику и модели данных. Они помогают поддерживать целостность и согласованность данных, а также обеспечивают четкие границы для управления состоянием объектов. Использование агрегатов упрощает разработку и поддержку сложных систем, делая код более понятным и управляемым.