**JWT (JSON Web Token)** — это компактный, URL-безопасный способ передачи информации между двумя сторонами в виде JSON-объектов. JWT часто используется для аутентификации и авторизации в веб-приложениях, особенно в системах с распределенной архитектурой, таких как микросервисы. Токен представляет собой строку, состоящую из трех частей, разделенных точками: **заголовок (header)**, **полезная нагрузка (payload)** и **подпись (signature)**.

### Структура JWT

JWT-токен состоит из трех частей, каждая из которых закодирована с использованием Base64 и разделена точками:

```
header.payload.signature
```

#### 1. **Header** (заголовок)
Заголовок обычно содержит тип токена и алгоритм, используемый для его подписи, например:

```json
{
  "alg": "HS256",  // Алгоритм подписи (например, HMAC SHA256)
  "typ": "JWT"     // Тип токена (JWT)
}
```

#### 2. **Payload** (полезная нагрузка)
Полезная нагрузка содержит утверждения (claims), представляющие информацию о пользователе и токене. Claims бывают **зарезервированные** (зарезервированные поля, такие как `iss`, `exp`, `sub`), **публичные** (настраиваемые разработчиком) и **приватные** (особые для приложения).

Пример claims:
```json
{
  "sub": "1234567890",       // Идентификатор субъекта (пользователя)
  "name": "John Doe",        // Имя пользователя
  "admin": true,             // Утверждение о статусе админа
  "iat": 1516239022,         // Время выдачи токена (issued at)
  "exp": 1516242622          // Время истечения срока действия токена (expiration)
}
```

#### 3. **Signature** (подпись)
Подпись создается для того, чтобы гарантировать целостность токена и его неподделанность. Она создается с использованием алгоритма, указанного в заголовке (например, HMAC SHA256), и секретного ключа сервера:

```
HMACSHA256(
  base64UrlEncode(header) + "." + base64UrlEncode(payload), secret)
```

Пример полной структуры JWT:
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c
```

### Как работает JWT?

1. **Аутентификация**:
   - Пользователь отправляет свои учетные данные (например, логин и пароль) на сервер.
   - Сервер проверяет данные и, если они верны, создает JWT-токен, содержащий информацию о пользователе и срок действия токена.

2. **Передача токена**:
   - JWT передается клиенту. Клиент сохраняет его (например, в localStorage или cookie) и использует для дальнейших запросов к серверу.

3. **Авторизация**:
   - При каждом запросе клиент отправляет JWT в заголовке запроса:
```http
Authorization: Bearer <jwt_token>
```

4. **Проверка токена**:
   - Сервер получает JWT, декодирует его и проверяет подпись, чтобы удостовериться, что токен не был подделан.
   - Если подпись верна и токен не истек, сервер предоставляет доступ к запрашиваемым ресурсам.

### Преимущества JWT

1. **Самодостаточность**:
   - JWT содержит всю необходимую информацию для авторизации, что устраняет необходимость хранить сессию на сервере.

2. **Универсальность**:
   - Токены могут использоваться как для авторизации, так и для передачи любой другой информации между участниками (например, для обмена данными между микросервисами).

3. **Компактность**:
   - JWT-токены компактны благодаря использованию JSON и Base64, что делает их подходящими для передачи в URL или HTTP-заголовках.

4. **Поддержка многих форматов подписи**:
   - JWT поддерживает различные алгоритмы подписи, такие как HMAC и RSA, что позволяет гибко настраивать безопасность.

### Недостатки и риски JWT

1. **Необратимость токенов**:
   - JWT-токены не могут быть отозваны до истечения срока действия. Если токен был скомпрометирован, система не может его отозвать (если не реализован черный список токенов).

2. **Уязвимость при утечке**:
   - Если злоумышленник завладеет токеном, он сможет получить доступ к системе до истечения срока действия токена.

3. **Безопасность хранения**:
   - Необходимо тщательно выбирать, где хранить токен на клиенте (например, хранение в `localStorage` менее безопасно, чем использование `HttpOnly` cookie).

### Безопасность JWT

1. **Подпись и валидация**:
   - JWT содержит подпись, которая обеспечивает целостность данных. Подпись подтверждает, что содержимое токена не было изменено.
  
2. **Шифрование**:
   - JWT могут быть не только подписаны, но и зашифрованы для обеспечения конфиденциальности данных (JWE — JSON Web Encryption).

3. **Использование HTTPS**:
   - Чтобы предотвратить утечку токена в процессе передачи, его следует передавать только через защищенные соединения (HTTPS).

4. **Токен с коротким сроком жизни**:
   - Чем короче срок действия токена, тем меньше времени злоумышленник сможет его использовать в случае утечки.

### Пример работы с JWT в PHP

```php
require 'vendor/autoload.php';

use Firebase\JWT\JWT;
use Firebase\JWT\Key;

// Секретный ключ для подписи токена
$secretKey = 'your-256-bit-secret';

// Данные, которые будут помещены в токен
$payload = [
    'iss' => 'https://your-domain.com',  // Издатель токена
    'iat' => time(),                     // Время создания
    'exp' => time() + 3600,              // Время истечения (1 час)
    'sub' => '1234567890',               // Идентификатор субъекта
    'name' => 'John Doe',                // Имя пользователя
    'admin' => true                      // Дополнительные данные
];

// Создание токена
$jwt = JWT::encode($payload, $secretKey, 'HS256');

// Отправка токена клиенту
echo $jwt;

// Декодирование токена при последующем запросе
$decoded = JWT::decode($jwt, new Key($secretKey, 'HS256'));
print_r($decoded);
```

### Заключение

JWT является мощным инструментом для аутентификации и обмена данными между системами. Он прост в использовании, универсален и широко поддерживается. Однако важно следовать лучшим практикам безопасности, чтобы минимизировать риски при использовании токенов в веб-приложениях.